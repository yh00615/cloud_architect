name: Quality Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run comprehensive review
        id: review
        run: |
          npm run review
          echo "review_completed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload review report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: review-report
          path: REVIEW_REPORT.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            try {
              const report = JSON.parse(fs.readFileSync('REVIEW_REPORT.json', 'utf8'));
              
              // ë“±ê¸‰ë³„ ì´ëª¨ì§€
              const gradeEmoji = {
                'A': 'ğŸŒŸ',
                'B': 'âœ…',
                'C': 'âš ï¸',
                'D': 'âŒ',
                'F': 'ğŸš¨'
              };
              
              // ì ìˆ˜ë³„ ìƒ‰ìƒ
              const getScoreColor = (score) => {
                if (score >= 90) return 'ğŸŸ¢';
                if (score >= 80) return 'ğŸŸ¡';
                if (score >= 70) return 'ğŸŸ ';
                return 'ğŸ”´';
              };
              
              // ì£¼ìš” ë¬¸ì œ ìš”ì•½
              const codeIssues = report.code.issues
                .filter(i => i.severity === 'error')
                .slice(0, 3)
                .map(i => `- âŒ **${i.category}**: ${i.message} (${i.count}ê°œ)`)
                .join('\n');
              
              const guideIssues = report.guides.issues
                .filter(i => i.severity === 'error')
                .slice(0, 3)
                .map(i => `- âŒ **${i.category}**: ${i.message} (${i.count}ê°œ)`)
                .join('\n');
              
              // ê¶Œì¥ì‚¬í•­
              const recommendations = report.overall.recommendations
                .slice(0, 3)
                .map((rec, idx) => {
                  const priorityEmoji = rec.priority === 'high' ? 'ğŸ”´' : rec.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                  return `${idx + 1}. ${priorityEmoji} **[${rec.priority.toUpperCase()}]** ${rec.message}\n   â†’ ${rec.action}`;
                })
                .join('\n\n');
              
              const comment = `
            ## ${gradeEmoji[report.overall.grade]} ì¢…í•© ê²€í†  ê²°ê³¼

            ### ğŸ“Š ì „ì²´ ì ìˆ˜
            ${getScoreColor(report.overall.score)} **${report.overall.score}ì ** (${report.overall.grade}ë“±ê¸‰)

            ---

            ### ğŸ“¦ ì†ŒìŠ¤ì½”ë“œ ê²€í† 
            | í•­ëª© | ê²°ê³¼ |
            |------|------|
            | ì´ ê²€ì‚¬ | ${report.code.total}ê°œ |
            | âœ… í†µê³¼ | ${report.code.passed}ê°œ |
            | âŒ ì‹¤íŒ¨ | ${report.code.failed}ê°œ |
            | âš ï¸ ê²½ê³  | ${report.code.warnings}ê°œ |

            ${codeIssues ? '**ì£¼ìš” ë¬¸ì œ:**\n' + codeIssues : 'âœ… ë¬¸ì œ ì—†ìŒ'}

            ---

            ### ğŸ“š ì‹¤ìŠµ ê°€ì´ë“œ ê²€í† 
            | í•­ëª© | ê²°ê³¼ |
            |------|------|
            | ì´ ê²€ì‚¬ | ${report.guides.total}ê°œ |
            | âœ… í†µê³¼ | ${report.guides.passed}ê°œ |
            | âŒ ì‹¤íŒ¨ | ${report.guides.failed}ê°œ |
            | âš ï¸ ê²½ê³  | ${report.guides.warnings}ê°œ |

            ${guideIssues ? '**ì£¼ìš” ë¬¸ì œ:**\n' + guideIssues : 'âœ… ë¬¸ì œ ì—†ìŒ'}

            ---

            ${recommendations ? '### ğŸ’¡ ê¶Œì¥ì‚¬í•­\n\n' + recommendations + '\n\n---\n' : ''}

            ### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„
            ${report.overall.score >= 80 
              ? 'âœ… **ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!** ëª¨ë“  ê¸°ì¤€ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤.' 
              : `âš ï¸ **ê°œì„  í•„ìš”**: ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì»¤ë°‹í•˜ì„¸ìš”.

            \`\`\`bash
            # ë¡œì»¬ì—ì„œ ê²€ì¦
            npm run review

            # ì˜¤ë¥˜ ìë™ ìˆ˜ì • ì‹œë„
            npm run lint:fix
            npm run fix:auto

            # ì¬ê²€ì¦
            npm run review
            \`\`\`
            `}

            ---

            <details>
            <summary>ğŸ“„ ìƒì„¸ ë¦¬í¬íŠ¸ ë³´ê¸°</summary>

            ì „ì²´ ë¦¬í¬íŠ¸ëŠ” [Artifacts](${context.payload.pull_request.html_url}/checks)ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            </details>
              `;
              
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ì¢…í•© ê²€í†  ê²°ê³¼')
              );
              
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒˆë¡œ ìƒì„±
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
              
            } catch (error) {
              console.error('ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âš ï¸ ì¢…í•© ê²€í†  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
              });
            }

      - name: Check quality threshold
        if: always()
        run: |
          if [ -f REVIEW_REPORT.json ]; then
            SCORE=$(node -p "require('./REVIEW_REPORT.json').overall.score")
            ERRORS=$(node -p "require('./REVIEW_REPORT.json').code.failed + require('./REVIEW_REPORT.json').guides.failed")
            
            echo "ğŸ“Š í’ˆì§ˆ ì ìˆ˜: ${SCORE}ì "
            echo "âŒ ì˜¤ë¥˜ ê°œìˆ˜: ${ERRORS}ê°œ"
            
            if [ $SCORE -lt 80 ]; then
              echo "::error::í’ˆì§ˆ ì ìˆ˜ê°€ 80ì  ë¯¸ë§Œì…ë‹ˆë‹¤ (í˜„ì¬: ${SCORE}ì )"
              exit 1
            fi
            
            if [ $ERRORS -gt 0 ]; then
              echo "::error::ì˜¤ë¥˜ê°€ ${ERRORS}ê°œ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”."
              exit 1
            fi
            
            echo "âœ… í’ˆì§ˆ ê¸°ì¤€ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤!"
          else
            echo "::error::REVIEW_REPORT.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
